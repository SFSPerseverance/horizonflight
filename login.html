<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Horizon Flight</title>

  <!-- Your global site CSS -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="auth-form.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
  <link rel="shortcut icon" href="assets/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
  <link rel="manifest" href="assets/site.webmanifest" />
</head>
<body>
  <main class="auth-page">
    <section class="auth-panel">
      <div id="authModalInline" class="modal-inline">
        <div class="modal-content">
          <button id="closeBtn" class="close" aria-label="Close">&times;</button>

          <!-- Login form block -->
          <div id="loginForm" class="auth-form">
            <h2>Login</h2>
            <form id="loginFormElement">
              <div class="input-group">
                <label for="loginUsername">Roblox User ID</label>
                <input id="loginUsername" name="loginUsername" type="text" placeholder="12345678" required />
              </div>
              <div class="input-group">
                <label for="loginPassword">Password</label>
                <input id="loginPassword" name="loginPassword" type="password" placeholder="••••••••" required />
              </div>
              <div style="display:flex; gap:10px; margin-top:12px;">
                <button type="submit" class="auth-btn" style="flex:1;">Login</button>
                <button id="showSignup" type="button" class="auth-btn" style="flex:1; background:transparent;">Sign up</button>
              </div>
            </form>
            <div id="loginError" class="form-error" aria-live="polite"></div>
          </div>

          <!-- Signup form block -->
          <div id="signupForm" class="auth-form" style="display:none;">
            <h2>Sign up</h2>
            <form id="signupFormElement">
              <div class="input-group">
                <label for="signupUsername">Roblox User ID</label>
                <input id="signupUsername" name="signupUsername" type="text" placeholder="12345678" required />
              </div>
              <div class="input-group">
                <label for="signupPassword">Password</label>
                <input id="signupPassword" name="signupPassword" type="password" placeholder="Strong password" required />
              </div>
              <div class="input-group">
                <label for="confirmPassword">Confirm password</label>
                <input id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm password" required />
              </div>
              <div style="display:flex; gap:10px; margin-top:12px;">
                <button type="submit" class="auth-btn" style="flex:1;">Create account</button>
                <button id="showLogin" type="button" class="auth-btn" style="flex:1; background:transparent;">Back to login</button>
              </div>
            </form>
            <div id="signupError" class="form-error" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Cookie helper function
    function setLoginCookie(username) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
      document.cookie = 'horizonUser=' + encodeURIComponent(username) + '; expires=' + expires.toUTCString() + '; path=/';
    }

    function getLoginCookie() {
      const name = "horizonUser=";
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    function getUserData(username) {
      const users = JSON.parse(localStorage.getItem('horizonUsers') || '{}');
      return users[username] || null;
    }

    function storeUserData(username, password, additionalData = {}) {
      const users = JSON.parse(localStorage.getItem('horizonUsers') || '{}');
      users[username] = {
        username: username,
        password: password,
        joinDate: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
        verified: false,
        verificationCode: null,
        ...additionalData
      };
      localStorage.setItem('horizonUsers', JSON.stringify(users));
    }

    async function getRobloxUsername(userId) {
      try {
        const response = await fetch(`https://users.roproxy.com/v1/users/${userId}`);
        const data = await response.json();
        return data && data.name ? data.name : null;
      } catch (err) {
        console.error("Error fetching Roblox username:", err);
        return null;
      }
    }

    function showMessage(text, type) {
      // Remove any existing messages
      document.querySelectorAll('.message').forEach(msg => msg.remove());

      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10001;
        animation: slideIn 0.3s ease;
        ${type === 'success' ? 'background: #4caf50;' : 'background: #f44336;'}
      `;
      message.textContent = text;

      document.body.appendChild(message);
      setTimeout(() => message.remove(), 4000);
    }

    function generateVerificationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // UI helpers
    function showLogin() { 
      document.getElementById('loginForm').style.display = ''; 
      document.getElementById('signupForm').style.display = 'none'; 
      document.getElementById('loginError').textContent = '';
      // Clear verification form if it exists
      const verifyForm = document.getElementById('verifyForm');
      if (verifyForm) verifyForm.remove();
    }

    function showSignup() { 
      document.getElementById('loginForm').style.display = 'none'; 
      document.getElementById('signupForm').style.display = ''; 
      document.getElementById('signupError').textContent = '';
      // Clear verification form if it exists
      const verifyForm = document.getElementById('verifyForm');
      if (verifyForm) verifyForm.remove();
    }

    function showVerificationForm(username, code) {
      // Remove existing verification form
      const existing = document.getElementById('verifyForm');
      if (existing) existing.remove();

      const container = document.querySelector('#authModalInline .modal-content');
      const verifyDiv = document.createElement('div');
      verifyDiv.id = 'verifyForm';
      verifyDiv.className = 'auth-form';
      verifyDiv.innerHTML = `
        <h2>Verify your account</h2>
        <p style="color:#b0b0b0; font-size:14px; margin-bottom:10px;">
          A one-time 6-digit verification code was generated for your signup.
          <strong>Enter that code in the Horizon Flight Roblox game</strong> (in the in-game verification UI).
          Once you've entered it there, click <em>Check verification</em> below.
        </p>
        <div class="input-group">
          <label>Your Roblox User ID</label>
          <input type="text" id="verifyUserId" value="${username}" disabled>
        </div>
        <div class="input-group">
          <label>Verification Status</label>
          <div id="verifyStatus" style="color:#b0b0b0; font-size:14px;">Waiting for verification from the Roblox game...</div>
        </div>
        <div style="display:flex; gap:10px;">
          <button id="checkVerificationBtn" class="auth-btn" style="flex:1;">Check verification</button>
          <button id="showCodeBtn" class="auth-btn" style="flex:1; background:transparent; border:1px solid rgba(100,181,246,0.3);">Show code</button>
        </div>
        <div id="revealedCode" style="margin-top:12px; color:#64b5f6; font-weight:700; display:none;">${code}</div>
        <p style="margin-top:12px; font-size:13px; color:#888;">If you're testing locally, you can click "Show code" and paste it into the Roblox game's verification input. In production you'd typically hide the code and have the Roblox game send the code to your server to mark the account verified.</p>
      `;

      // Hide login/signup forms
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      container.appendChild(verifyDiv);

      // Add button events
      document.getElementById('showCodeBtn').addEventListener('click', () => {
        const rc = document.getElementById('revealedCode');
        rc.style.display = rc.style.display === 'none' ? 'block' : 'none';
      });

      document.getElementById('checkVerificationBtn').addEventListener('click', async () => {
        const userData = getUserData(username);
        const statusEl = document.getElementById('verifyStatus');
        
        if (userData && userData.verified) {
          statusEl.textContent = 'Verified — signup complete!';
          statusEl.style.color = '#8ee28e';

          // Log in the user
          setLoginCookie(username);
          
          // Redirect to home page
          setTimeout(() => {
            window.location.href = '/horizonflight/home';
          }, 800);
          showMessage('Verification successful — welcome!', 'success');
        } else {
          statusEl.textContent = 'Not verified yet. Enter the code in the Roblox game.';
          statusEl.style.color = '#ffbaba';
        }
      });
    }

    // Get return URL from query parameters
    function getReturnTo() {
      const params = new URLSearchParams(window.location.search);
      return params.get('returnTo') || '/horizonflight/home';
    }

    // Login handler
    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      if (!username || !password) {
        errorEl.textContent = 'Please fill in all fields';
        return;
      }

      const userData = getUserData(username);
      
      if (!userData) {
        errorEl.textContent = 'Username not found. Please sign up first.';
        return;
      }

      if (userData.password !== password) {
        errorEl.textContent = 'Incorrect password';
        return;
      }

      if (!userData.verified) {
        errorEl.textContent = 'Account not verified yet — please verify using the Roblox game.';
        showVerificationForm(username, userData.verificationCode || '------');
        return;
      }

      // Success - set cookie and redirect
      setLoginCookie(username);
      
      // Update last login
      userData.lastLogin = new Date().toISOString();
      storeUserData(username, password, userData);

      const robloxUsername = await getRobloxUsername(username);
      showMessage(`Welcome back, ${robloxUsername || username}!`, 'success');
      
      setTimeout(() => {
        window.location.href = getReturnTo();
      }, 1000);
    }

    // Signup handler
    async function handleSignup(event) {
      event.preventDefault();
      
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('signupError');

      // Validation
      if (!username || !password || !confirmPassword) {
        errorEl.textContent = 'Please fill in all fields';
        return;
      }

      if (!/^\d+$/.test(username)) {
        errorEl.textContent = 'User ID must be numbers only';
        return;
      }

      if (password !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        return;
      }

      const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[\W_]).{8,}$/;
      if (!passwordRegex.test(password)) {
        errorEl.textContent = 'Password must be at least 8 characters and include uppercase, lowercase, number, and special character';
        return;
      }

      // Check if Roblox user exists
      const robloxUsername = await getRobloxUsername(username);
      if (!robloxUsername) {
        errorEl.textContent = 'Invalid Roblox User ID';
        return;
      }

      // Check if user already exists
      const existingUser = getUserData(username);
      if (existingUser) {
        errorEl.textContent = 'User already exists';
        return;
      }

      // Generate verification code and store user
      const verificationCode = generateVerificationCode();
      storeUserData(username, password, {
        verified: false,
        verificationCode: verificationCode
      });

      showMessage('Signup created — awaiting verification from the Roblox game', 'success');
      showVerificationForm(username, verificationCode);
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      // Check if already logged in
      const loggedInUser = getLoginCookie();
      if (loggedInUser) {
        window.location.href = getReturnTo();
        return;
      }

      // Wire up UI toggle buttons
      document.getElementById('showSignup').addEventListener('click', showSignup);
      document.getElementById('showLogin').addEventListener('click', showLogin);
      
      // Close button redirects to home
      document.getElementById('closeBtn').addEventListener('click', () => {
        window.location.href = '/horizonflight/home';
      });

      // Form submissions
      document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
      document.getElementById('signupFormElement').addEventListener('submit', handleSignup);

      // Show login form initially
      showLogin();
    });

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>