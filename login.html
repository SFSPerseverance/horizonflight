<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Horizon Flight</title>

  <!-- Your global site CSS (ensure this path matches your project) -->
  <link rel="stylesheet" href="style.css">

  <!-- Extracted auth-form CSS (optional if your global CSS covers it) -->
  <link rel="stylesheet" href="auth-form.css">
  

  <!-- Font Awesome if your site uses it for the sidebar icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-...omitted..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="shortcut icon" href="assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
    <link rel="manifest" href="assets/site.webmanifest" />
</head>
<body>
  <main class="auth-page">
    <section class="auth-panel">
      <!-- --- EXACT original modal form markup moved to a page --- -->
      <div id="authModalInline" class="modal-inline">
        <div class="modal-content">
          <button id="closeBtn" class="close" aria-label="Close">&times;</button>

          <!-- Login form block (shown on page) -->
          <div id="loginForm" class="auth-form">
            <h2>Login</h2>
            <form id="loginFormElement">
              <div class="input-group">
                <label for="loginUsername">Roblox User id</label>
                <input id="loginUsername" name="loginUsername" type="text" placeholder="12345678" required />
              </div>
              <div class="input-group">
                <label for="loginPassword">Password</label>
                <input id="loginPassword" name="loginPassword" type="password" placeholder="••••••••" required />
              </div>
              <div style="display:flex; gap:10px; margin-top:12px;">
                <button type="submit" class="auth-btn" style="flex:1;">Login</button>
                <button id="showSignup" type="button" class="auth-btn" style="flex:1; background:transparent;">Sign up</button>
              </div>
            </form>
            <div id="loginError" class="form-error" aria-live="polite"></div>
          </div>

          <!-- Signup form block (shown on page) -->
          <div id="signupForm" class="auth-form" style="display:none;">
            <h2>Sign up</h2>
            <form id="signupFormElement">
              <div class="input-group">
                <label for="signupUsername">Roblox User id</label>
                <input id="signupUsername" name="signupUsername" type="text" placeholder="12345678" required />
              </div>
              <div class="input-group">
                <label for="signupPassword">Password</label>
                <input id="signupPassword" name="signupPassword" type="password" placeholder="Strong password" required />
              </div>
              <div class="input-group">
                <label for="confirmPassword">Confirm password</label>
                <input id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm password" required />
              </div>
              <div style="display:flex; gap:10px; margin-top:12px;">
                <button type="submit" class="auth-btn" style="flex:1;">Create account</button>
                <button id="showLogin" type="button" class="auth-btn" style="flex:1; background:transparent;">Back to login</button>
              </div>
            </form>
            <div id="signupError" class="form-error" aria-live="polite"></div>
          </div>

          <!-- Verification form area (will be injected/displayed by existing script if present) -->
          <div id="verificationArea"></div>
        </div>
      </div>
      <!-- end auth markup -->
    </section>
  </main>

  <script>
  (function(){
    // Utility: safe JSON fetch for config
    async function loadConfig(){
      try{
        const r = await fetch('/auth-config.json', {cache:'no-store'});
        if(!r.ok) throw new Error('Failed to load auth-config.json');
        return await r.json();
      }catch(e){
        // fallback config (local dev)
        return {
          apiBase: '',
          endpoints: { createVerification: '/api/create-verification', verifyStatus:'/api/verify-status', users:'/api/users' }
        };
      }
    }

    // Helper: show/hide UI blocks
    function showLogin(){ document.getElementById('loginForm').style.display = ''; document.getElementById('signupForm').style.display = 'none'; document.getElementById('loginError').textContent=''; }
    function showSignup(){ document.getElementById('loginForm').style.display = 'none'; document.getElementById('signupForm').style.display = ''; document.getElementById('signupError').textContent=''; }

    // Try to use your existing global helper if available, otherwise fallback to our internal functions
    const usesGlobal = {
      showLoginForm: typeof window.showLoginForm === 'function',
      showSignupForm: typeof window.showSignupForm === 'function',
      initializeAuth: typeof window.initializeAuth === 'function'
    };

    document.addEventListener('DOMContentLoaded', async ()=>{

      // If original initializeAuth exists, call it (keeps behavior consistent)
      if(usesGlobal.initializeAuth){
        try{ window.initializeAuth(); }catch(e){ console.warn('initializeAuth threw', e); }
      }

      // If your site had functions to toggle, prefer them
      const btnShowSignup = document.getElementById('showSignup');
      const btnShowLogin = document.getElementById('showLogin');
      btnShowSignup.addEventListener('click', (e)=>{ if(usesGlobal.showSignupForm){ window.showSignupForm(); } else showSignup(); });
      btnShowLogin.addEventListener('click', (e)=>{ if(usesGlobal.showLoginForm){ window.showLoginForm(); } else showLogin(); });

      // Close button (just goes back to home)
      document.getElementById('closeBtn').addEventListener('click', ()=>{ window.location.href = '/'; });

      // Login submit
      document.getElementById('loginFormElement').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const err = document.getElementById('loginError');
        err.textContent = '';

        if(!username || !password){ err.textContent = 'Please fill both fields.'; return; }

        // If your site has a global handler, call it (keeps exact original flow)
        if(typeof window.handleLogin === 'function'){
          try{
            await window.handleLogin({username, password});
            // assume handleLogin sets localStorage/token and redirects
            return;
          }catch(e){ err.textContent = e.message || 'Login failed'; return; }
        }

        // Otherwise perform a best-effort API call using auth-config.json
        const cfg = await loadConfig();
        const apiBase = cfg.apiBase || '';
        const tryEndpoints = [
          apiBase + '/api/login',
          apiBase + (cfg.endpoints && cfg.endpoints.users ? cfg.endpoints.users + '/login' : '/api/users/login'),
          apiBase + '/api/users/login'
        ];

        let respJson = null;
        let success = false;
        for(const url of tryEndpoints){
          try{
            const r = await fetch(url, {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ username, password })
            });
            if(!r.ok){
              // try next endpoint
              continue;
            }
            respJson = await r.json().catch(()=>null);
            success = true;
            break;
          }catch(e){
            // network error -> try next
            continue;
          }
        }

        if(success && respJson){
          // Expecting { token, user } from backend (keeps parity with previous code)
          const token = respJson.token || respJson.accessToken || respJson.authToken;
          const user = respJson.user || { name: username, id: respJson.id || null, email: respJson.email || null };
          if(token){
            localStorage.setItem('authToken', token);
            localStorage.setItem('authUser', JSON.stringify(user));
            // Redirect to home or to return URL if present
            const returnTo = 'horizonflight/home.html';
            window.location.href = returnTo;
            return;
          } else {
            err.textContent = respJson.message || 'Login failed: invalid credentials';
            return;
          }
        }

        // Final fallback: local dev login (accept any non-empty password) — remove in production
        console.warn('Auth endpoints unreachable — using local fallback login (dev only).');
        localStorage.setItem('authToken', 'dev-token-' + Date.now());
        localStorage.setItem('authUser', JSON.stringify({ name: username, email: '' }));
        window.location.href = '/horizonflight/home.html';
      });

      // Signup submit
      document.getElementById('signupFormElement').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const username = document.getElementById('signupUsername').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        const err = document.getElementById('signupError');
        err.textContent = '';

        if(!username || !password){ err.textContent = 'Please fill required fields.'; return; }
        if(password !== confirm){ err.textContent = 'Passwords do not match.'; return; }

        // If your site has a global handler, call it
        if(typeof window.handleSignup === 'function'){
          try{
            await window.handleSignup({username, password});
            return;
          }catch(e){ err.textContent = e.message || 'Signup failed'; return; }
        }

        // Otherwise do best-effort API call using auth-config.json
        const cfg = await loadConfig();
        const apiBase = cfg.apiBase || '';
        const signupUrls = [
          apiBase + (cfg.endpoints && cfg.endpoints.users ? cfg.endpoints.users : '/api/users'),
          apiBase + '/api/register'
        ];

        let created = false, createdResp = null;
        for(const url of signupUrls){
          try{
            const r = await fetch(url, {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ username, password })
            });
            if(!r.ok) continue;
            createdResp = await r.json().catch(()=>null);
            created = true;
            break;
          }catch(e){ continue; }
        }

        if(created && createdResp){
          // If backend returns a token, use it. Otherwise fallback to dev flow.
          const token = createdResp.token || createdResp.accessToken;
          const user = createdResp.user || { name: username, email: '' };
          if(token){
            localStorage.setItem('authToken', token);
            localStorage.setItem('authUser', JSON.stringify(user));
            window.location.href = '/';
            return;
          } else {
            // Some backends require a verification flow: show message and bring forward verification UI if available
            alert('Account created. Please verify your account if required. Redirecting to home.');
            window.location.href = '/';
            return;
          }
        }

        // Fallback dev create
        console.warn('Signup endpoints unreachable — using local fallback create (dev only).');
        localStorage.setItem('authToken', 'dev-token-' + Date.now());
        localStorage.setItem('authUser', JSON.stringify({ name: username, email: '' }));
        window.location.href = '/';
      });

      // Initially show login form
      showLogin();
    });

  })();
  </script>

</body>
</html>